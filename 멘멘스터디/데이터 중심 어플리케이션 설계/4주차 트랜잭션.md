#### 출처 : 쉬운코드 , 데이터중심어플리케이션설계 - 마틴 클레프만
### 애매모호한 트랜잭션의 개념

2000년대 후반부터 빅데이터 시대가 도래하면서 대규모 데이터를 처리해야하는 요구사항이 증가했다.
비관계형 데이터베이스로 새로운 데이터 모델을 선택하며, 확장성을 위해 파티셔닝과 샤딩, 데이터 무결성을 위해 복제를 활용하는 시스템에서 트랜잭션을 유지하면 성능이 크게 저하되는 문제가 생겼다.

- 높은 성능과 고가용성을 위해 트랜잭션을 포기하자
- 값진 데이터가 있는 어플리케이션에선 트랜잭션은 필수다

이분법적으로 나누는 것은 과장이다.
트랜잭션의 이점과 한계를 알아보고 트레이드오프를 이해하기 위해 트랜잭션과 트랜잭션이 지니는 속성에 대해 알아보자.

---
### 트랜잭션이란? 
생성, 수정, 삭제 또는 읽는 작업을 단일 작업으로 묶어서 나누어질 수 없게 만들 것. 
일부만 성공한다면 DB에 반영하지 않는다. 

ex ) J 가 H 에 20 만원을 이체하고자 한다면?
![](https://i.imgur.com/DmdiF2m.png)

2개의 sql 문이 전부 성공해야 이체 작업이 성공한다. 
2개의 sql 문은 한 트랜잭션으로 묶인다.

![](https://i.imgur.com/jVs9SQ3.png)

commit 명령어는 지금까지 작업한 내용을 DB에 영구적으로 저장하는 명령어이자 transaction 을 종료하는 명령어다.

ex ) 추가로 J 가 H 에 30 만원을 이체하고자 한다면?
![](https://i.imgur.com/417GJpu.png)

rollback 명령어는 지금가지 작업을 모두 종료하고 transaction 이전 상태로 되돌리고 transaction을 종료하는 명령어다.
### 일반적인 transaction 사용패턴
![](https://i.imgur.com/HavhTCh.png)
### 자바
![](https://i.imgur.com/38FQWk5.png)

이체 담당 로직을 제외한 트랜잭션 코드를 스프링에서 따로 관리해준다.

### 스프링
@Transactional 어노테이션를 붙이면 이체 담당 로직만 둬도 된다.
![](https://i.imgur.com/jQMjVie.png)

---
### 트랜잭션속성 AICD

#### - 원자성 ( Atomicity )

모두 성공하거나 모두 실패하거나
트랜잭션은 논리적으로 쪼갤 수 없는 작업이기에 내부 sql 문이 모두 성공해야한다.
만약 중간에 실패하면 지금까지의 작업을 모두 취소하여 아무 일도 없던 것처럼 rollback 한다.

![](https://i.imgur.com/77AN04k.png)

commit 발생시 db에 영구적으로 저장하고, rollback 시 이전 상태로 돌리는 것은 dbms 역할
언제 commit 하거나 rollback 할진 개발자의 역할이다.

---
#### - 일관성 ( Consistency )

ex ) 만약 J 가 H 에게 추가로 100만원을 이체하고자 한다면?

![](https://i.imgur.com/dYuCSUO.png)

##### 처음 account table 을 만들때, balance 가 음수가 될 수 없다는 제약을 걸었다면? 
이 update 문은 실패하고, rollback 을 한다.
DB에 정의된 rule 을 transaction 이 위반했다면, DBMS이 commit 전에 이를 확인하고 알려준 뒤, rollback 한다. ( 개발자는 exception이 던져지면 rollback 로직을 짜둬야 한다. )
추가적으로 어플리케이션 관점에서 transaction이 일관성 있게 동작하는지 개발자가 챙겨야한다. 

AICD 중 유일하게 데이터베이스의 속성이 아닌 어플리케이션 속성이자 어플리케이션이 데이터의 일관성을 유지하도록 트랜잭션을 정의해야 충족된다.

---
#### - 격리성( isolation )

ex ) 만약 J 가 H 에게 20 만원을 이체하고자 하는데, H도 30 만원을 자기 계좌에게 입금한다면?

![](https://i.imgur.com/YCiPPql.png)

파란 트랜잭션은 분홍 트랜잭션이 실행되었는지 모른다!
즉, 여러 transaction을 동시에 실행하니 문제가 생긴다. 

따라서 여러 여러 transaction이 동시에 실행될 때도 혼자 실행되는 것처럼 동작하게 만드는 성질이 격리성이다.
하지만, 엄격하게 구분하면 db 서버 퍼포먼스가 줄어들기에 여러 isolation level 을 제공한다.
개발자는 어떤 level 로 transation을 동작시킬지 설정할 수 있다.

---
#### - 지속성 ( durability )
commit 한 트랜잭션은 db 에 영구적으로 저장된다. -> 비휘발성 메모리 ( HHD, SSD .. )에 저장함을 의미한다. 
절대적 보장을 제공하는 한 가지 기법은 없기에 디스크에 쓰기 , 원격 장비에 복제하기 , 백업 등을 함께 사용하여 데이터 손실의 가능성을 줄여야 한다. 

---


