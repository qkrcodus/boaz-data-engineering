#### 출처 : 가상 면접 사례로 배우는 대규모 시스템 설계 기초 - 알렉스 쉬
를 토대로 이해한 내용을 정리했습니다.

#### 1- DNS 서버와 웹서버 ( 웹 계층 )
사용자는 url 에 도메인 이름을 검색한다.
DNS 서버가 도메인 네임을 받고 IP 주소를 반환한다. 
IP 주소를 통해 웹 브라우저는 웹 서버에 접속한다. 

---

#### 2- 어플리케이션 서버와 데이터 베이스 서버 ( 데이터 계층)
사용자 요청에 어플리케이션 서버와 ( 요청 처리하는 비즈니스 로직 담당 )
데이터 베이스 서버( 데이터 저장 담당 )가 함께 상호 작용하여 응답 

---

#### 3- 어떤 데이터 베이스를 사용할 것 인가? 
[관계형 데이터 베이스]
고객 주문 서비스를 설계한다 할 때,
customer table ( 고객 id, 이름)
order table ( 주문 id, 고객 id, 주문 금액)

만약 특정 고객의 주문 정보를 조회하려면, 두 테이블을 고객 id 로 join 할 필요가 있다.

[비관계형 데이터 베이스]
- 원래의 데이터(객체)를 전송이 가능한 json이나 xml 로 변환하는 직렬화나, 역직렬화만 필요한 경우 (ex. mongo DB)
- 아주 많은 양의  데이터 저장할 경우
- 실시간 처리 등 빠른 응답 시간 필요한 경우 (ex. Redis는 디스크 기반 저장보다 훨씬 빠르다)
- 데이터가 애초에 비정형일 경우 

---

#### 4-  웹 성능 최적화 전략 ( 웹 계층 - 로드밸린서 , 데이터 계층의 트래픽 처리- 데이터베이스 다중화 , 응답 시간 개선- 캐시, cdn )
수직적 규모 확장은 성능이 더 좋은 cpu 나 ram을 이용하는 방법이다. 하지만, 이 방법은 성능을 무한대로 증설할 방법이 없기에 한계가 있다.

##### 로드밸린서 ( 웹 계층)
대규모 트래픽을 처리하기 위한 수평적 규모 확장 방법으로 로드밸런서가 있다.

![](https://i.imgur.com/Obr003s.png)

대규모 서비스에선 사용자의 url get 요청에 DNS 서버가 웹서버의 IP 주소가 아닌 로드밸린서의 IP 주소를 줄 수도 있다. 클라이언트 요청은 로드 밸린서로 전달되고, 로드밸린서는 적절한 기준에 따라 웹 서버를 선택한다. (서버 상태 고려 )

[질문] 서버를 갈아 끼울 수 있는 이유가?
자동화된 배포 도구 ( jetkins, ansible,kubernetes) 가 모든 서버가 동일한 방식으로 요청을 처리할 수 있게 동일한 소프트웨어 구성인지 감시하고, 버전 관리를 해준다. 
또한, http 요청은 serveless( 서버에 정보를 저장하지 않음 )기에 가능하다

이로 인해 로드밸린서 아래 새로운 서버를 설치할 수도 있고, 서버가 다운되거나 트래픽 양 따라 서버 부하를 방지하기 위해 다른 서버에 요청을 보낼 수 있다. 

로드밸린서 와 서버 , 서버들끼리의 통신엔 사설 IP 주소가 사용된다.

[질문] 동일한 사설 IP 주소를 사용할 수 있는 이유? 
NAT 기술은 네트워크가 외부와 연결 될 때 사설 IP를 외부에서 사용할 수 있는 외부 IP 주소로 변환한다.

##### 데이터베이스 다중화 ( 데이터 계층 )
![](https://i.imgur.com/XhsryLJ.png)
주 데이터베이스에 c,u,d 요청 보내고, read 요청은 부 데이터베이스에 보낸다. 어플리케이션에서 주로 읽기 요청이 많이 발생하기에 요청을 병렬적으로 처리하므로 더 많은 쿼리를 보낼 수 있다.

###### 로드밸린서와 데이터베이스 다중화를 모두 사용한다면?

![](https://i.imgur.com/jsxbUZq.png)
##### 캐시 ( 응답 시간 개선 ) 

![](https://i.imgur.com/6MQiN1M.png)
컴퓨터 구조에서 cpu - 메모리의 접근 속도를 올리기 위해 캐시가 사용된다면 ( 메모리 접근 시간을 줄인다 )
웹 캐시에선 웹 서버 - 데이터베이스의 데이터 전송 속도를 올리기 위해 사용된다.  ( 데이터 베이스 서버의 부하를 줄인다 )

캐시 용량은 한정적이기에 주로 LRU 방식으로 공간을 확보한다. 
단일 장애 지점에 주로 놓고 캐시와 데이터 베이스가 같은 데이터를 공유하도록 유지해야한다. 


##### CDN ( 콘텐츠 전송 네트워크 )
정적 컨텐츠( 이미지, 비디오, css, js )등을 캐시 한다. 
사용자가 웹 사이트에 방문하면 지리적으로 가장 가까운 cdn 서버가 정적 콘텐츠를 전달한다. cdn은 캐시 역할을 하며, 정적 컨텐츠는 웹 서버 -> 데이터 베이스를 통해 얻지 않아 데이터 베이스의 부하를 줄여준다. 


![](https://i.imgur.com/6AKEGKM.png)

[즉, 웹 계층에선 로드 밸린서를 통해 트래픽을 분배하고, 데이터 계층에선 데이터 베이스 다중화를 통해 더 많은 쿼리를 병렬적으로 처리 가능하게 하고, 그리고 정적 컨텐츠를 보관하는 cdn, 자주 접근되는 정보는 캐시에 저장하여 특정 데이터 베이스에 접근하는 횟수를 줄여 웹 성능 최적화에 기여한다.]

---

#### 5- 웹의 수평적 확장

##### 웹 계층의 무상태성 , 공유 저장소

![](https://i.imgur.com/l9oJFjY.png)
상태 정보를 포함하는 서버는 같은 클라이언트로부터의 요청을 항상 같은 서버가 처리해야한다는 문제가 있다. ( 로드밸린서의 sticky session이 이를 지원하지만, 로드밸린서의 이점이였던 분산을 위한 서버 추가 기능을 못 쓰게 된다.)

따라서 웹 계층은 무상태여야 한다. 그리고 이게 맞게 통신 프로토콜 http 또한 무상태 (stateless이다)

만약 웹 서버가 상태 정보가 필요하다면 공유 저장소를 두어 데이터를 가져온다. 
![](https://i.imgur.com/xfgCPlt.png)
[즉, 웹 계층이 무상태성이기에 서버를 추가로 둘 수 있어 수평적 확장이 가능하고 , 데이터 저장소가 필요할 땐 공유 저장소를 이용하면 된다.]
##### 데이터 센터
넷플릭스는 전통적인 데이터 센터에서 클라우드 인프라로 이전했다.
클라우드 컴퓨팅의 등장으로 많은 기업들이 클라우드로 전환하는 추세다.

[질문] 둘의 차이가 뭘까?
- 클라우드 : 사용량 기반 비용을 내고, 리소스를 필요에 따라 즉시 조정 가능하다 , 클라우드 서비스 제공자 (예 : aws )가 인프라 유지를 관리한다
- 데이터 센터 : 사용자가 인프라 유지를 직접 해야하며, 물리적 위치에 제한되고, 높은 초기 투자 비용과 유지 관리 비용이 필요하다.
##### 메시지 큐
생산자는 메시지를 만들어 메시지 큐에 발행하면, 소비자가 꺼내 읽을 때까지 보관된다. ( 데이터 무손실 )
비동기 통신 => 실행되는 작업이 끝날 때까지 기다리지 않고 다른 작업을 병렬적으로 처리 가능하게 한다. 
메시지 큐 처리 기술론 redis( 빠른 접근 ) 와 rabbitmq ( 높은 신뢰성 )가 있다. 

[시스템 각 부분을 독립적으로 설계 가능하게 하고 서비스들은 메시지 큐로 통신한다. 따라서 서비스가 변경되어도 다른 시스템에 미치는 영향을 최소화한다. 특정 서비스의 확장을 가능하게 한다.]

##### 로그 ,매트릭 ,자동화
로그 데이터로 시스템 병목 형상이나, 에러를 확인한다
매트릭으로 cpu 사용량, 메모리 사용량, 네트워크 트래픽, 응답 시간 같은 성능 지표를 수집한다
자동화로 트래픽 양에 따라 자동으로 서버를 배포하거나 축소한다
![](https://i.imgur.com/Q9KFsNa.png)
[웹 서버는 처리할 작업을 메시지 큐에 전달하고, 작업 서버는 이 메시지를 받아 해당 작업을 비동기 처리하여 웹 서버의 응답 속도를 단축한다.]

---
#### 6- 데이터베이스의 규모 확장
1. 수직적 확장 : cpu ram 성능 향상, 다만 무한 증설이 불가능하다
2. 수평적 확장 (sharding): 샤딩키 기준 데이터 분할

하지만, shard 꽉 찰 경우, 재샤딩 문제와 특정 샤드에 쿼리가 집중되어 서버 과부하 걸리는 문제, 여러 샤드에 걸친 데이터를 조인하기 힘든 문제가 있다 ( 비정규화 시켜서 조인시킬 수 있긴 하다)
![](https://i.imgur.com/coLhN9y.png)


#### 정리하자면 대규모 설계를 위해 

- 웹 계층은 무상태로 -> 서버 추가와 삭제 가능하게
- 모든 계층에 다중화 도입 -> 데이터 베이스, 캐시, 웹서버-작업서버
- 여러 데이터 센터 지원 -> 최근 클라우드로 이전
- 정적 컨텐츠는 cdn
- 데이터 계층은 샤딩
- 각 계층은 독립적 서비스로 분할하여 MSA 아키텍쳐 구현하여 각 서비스가 독립적으로 개발 , 배포 , 확장 가능하게 함
- 시스템을 모니터링하고 자동화 도구들 활용하기

[질문] 데이터 계층은 샤딩하는게 데이터 베이스 수평적 확장에 왜 도움을 줄까?
데이터 베이스를 나눠 독립적 처리를 가능하게 하여 서버 분산을 돕고, 병렬적 처리로 속도도 향샹된다

---
#### 7- 성능 측정하는 방법

<개략적 규모 측정>
main memory - 100ns
disk - 10ms
packet from 캘리포니아 to 네덜란드 - 150ms

디스크가 아직 느리다. 데이터 센터는 보통 여러 지역에 분산되어있고, 센터들간 데이터 주고 받는 시간이 걸린다. 압축해서 데이터 보내자